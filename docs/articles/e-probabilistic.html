<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Probabilistic Uncertainty Analysis â€¢ heemod</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">heemod</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pierucci/heemod">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Probabilistic Uncertainty Analysis</h1>
            
            <h4 class="date">2017-05-09</h4>
          </div>

    
    
<div class="contents">
<p>This vignette shows how to transform the deterministic Markov model presented in <code>vignette("c-homogeneous", "heemod")</code> in a probabilistic model.</p>
<div id="model-definition" class="section level2">
<h2 class="hasAnchor">
<a href="#model-definition" class="anchor"></a>Model definition</h2>
<p>We will start by re-specifying the deterministic model of HIV therapy described previously (a monotherapy strategy <code>mono</code> and combined therapy strategy <code>comb</code>).</p>
<p>But instead of defining transition probabilities and state values directly in <code><a href="../reference/define_transition.html">define_transition()</a></code> or <code><a href="../reference/define_state.html">define_state()</a></code> (as in the previous vignette), parameters will be defined first in a <code><a href="../reference/define_parameters.html">define_parameters()</a></code> step. This is because only parameters defined this way can be resampled in a probabilistic analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">param &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_parameters.html">define_parameters</a></span>(
  <span class="dt">rr =</span> .<span class="dv">509</span>,
  
  <span class="dt">p_AA_mono =</span> .<span class="dv">721</span>,
  <span class="dt">p_AB_mono =</span> .<span class="dv">202</span>,
  <span class="dt">p_AC_mono =</span> .<span class="dv">067</span>,
  <span class="dt">p_AD_mono =</span> .<span class="dv">010</span>,
  
  <span class="dt">p_BC_mono =</span> .<span class="dv">407</span>,
  <span class="dt">p_BD_mono =</span> .<span class="dv">012</span>,
  
  <span class="dt">p_CD_mono =</span> .<span class="dv">250</span>,
  
  
  <span class="dt">p_AB_comb =</span> p_AB_mono *<span class="st"> </span>rr,
  <span class="dt">p_AC_comb =</span> p_AC_mono *<span class="st"> </span>rr,
  <span class="dt">p_AD_comb =</span> p_AD_mono *<span class="st"> </span>rr,
  
  <span class="dt">p_BC_comb =</span> p_BC_mono *<span class="st"> </span>rr,
  <span class="dt">p_BD_comb =</span> p_BD_mono *<span class="st"> </span>rr,
  
  <span class="dt">p_CD_comb =</span> p_CD_mono *<span class="st"> </span>rr,
  
  <span class="dt">p_AA_comb =</span> <span class="dv">1</span> -<span class="st"> </span>(p_AB_comb +<span class="st"> </span>p_AC_comb +<span class="st"> </span>p_AD_comb),
  
  
  <span class="dt">cost_zido =</span> <span class="dv">2278</span>,
  <span class="dt">cost_lami =</span> <span class="dv">2086</span>,
  
  <span class="dt">cost_A =</span> <span class="dv">2756</span>,
  <span class="dt">cost_B =</span> <span class="dv">3052</span>,
  <span class="dt">cost_C =</span> <span class="dv">9007</span>
)</code></pre></div>
<p>We need to define <code>p_AA_mono</code> and <code>p_AA_comb</code> in <code><a href="../reference/define_parameters.html">define_parameters()</a></code> because we will need to resample that value. Only values defined with <code><a href="../reference/define_parameters.html">define_parameters()</a></code> can be resampled. So we cannot use the complement alias <code>C</code> to specify <code>p_AA_comb</code> in <code><a href="../reference/define_transition.html">define_transition()</a></code>, as we did before.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mat_trans_mono &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_transition.html">define_transition</a></span>(
  p_AA_mono, p_AB_mono, p_AC_mono, p_AD_mono,
  <span class="dv">0</span>,         C,         p_BC_mono, p_BD_mono,
  <span class="dv">0</span>,         <span class="dv">0</span>,         C,         p_CD_mono,
  <span class="dv">0</span>,         <span class="dv">0</span>,         <span class="dv">0</span>,         <span class="dv">1</span>
)</code></pre></div>
<pre><code>## No named state -&gt; generating names.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mat_trans_comb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_transition.html">define_transition</a></span>(
  p_AA_comb, p_AB_comb, p_AC_comb, p_AD_comb,
  <span class="dv">0</span>,         C,         p_BC_comb, p_BD_comb,
  <span class="dv">0</span>,         <span class="dv">0</span>,         C,         p_CD_comb,
  <span class="dv">0</span>,         <span class="dv">0</span>,         <span class="dv">0</span>,         <span class="dv">1</span>
)</code></pre></div>
<pre><code>## No named state -&gt; generating names.</code></pre>
<p>State definition remains the same in this example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">state_A &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_state.html">define_state</a></span>(
    <span class="dt">cost_health =</span> <span class="dv">2756</span>,
    <span class="dt">cost_drugs =</span> <span class="kw"><a href="../reference/dispatch_strategy.html">dispatch_strategy</a></span>(
      <span class="dt">mono =</span> cost_zido,
      <span class="dt">comb =</span> cost_zido +<span class="st"> </span>cost_lami
    ),
    <span class="dt">cost_total =</span> <span class="kw"><a href="../reference/discount.html">discount</a></span>(cost_health +<span class="st"> </span>cost_drugs, .<span class="dv">06</span>),
    <span class="dt">life_year =</span> <span class="dv">1</span>
  )
state_B &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_state.html">define_state</a></span>(
    <span class="dt">cost_health =</span> <span class="dv">3052</span>,
    <span class="dt">cost_drugs =</span> <span class="kw"><a href="../reference/dispatch_strategy.html">dispatch_strategy</a></span>(
      <span class="dt">mono =</span> cost_zido,
      <span class="dt">comb =</span> cost_zido +<span class="st"> </span>cost_lami
    ),
    <span class="dt">cost_total =</span> <span class="kw"><a href="../reference/discount.html">discount</a></span>(cost_health +<span class="st"> </span>cost_drugs, .<span class="dv">06</span>),
    <span class="dt">life_year =</span> <span class="dv">1</span>
  )
state_C &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_state.html">define_state</a></span>(
    <span class="dt">cost_health =</span> <span class="dv">9007</span>,
    <span class="dt">cost_drugs =</span> <span class="kw"><a href="../reference/dispatch_strategy.html">dispatch_strategy</a></span>(
      <span class="dt">mono =</span> cost_zido,
      <span class="dt">comb =</span> cost_zido +<span class="st"> </span>cost_lami
    ),
    <span class="dt">cost_total =</span> <span class="kw"><a href="../reference/discount.html">discount</a></span>(cost_health +<span class="st"> </span>cost_drugs, .<span class="dv">06</span>),
    <span class="dt">life_year =</span> <span class="dv">1</span>
  )
state_D &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_state.html">define_state</a></span>(
    <span class="dt">cost_health =</span> <span class="dv">0</span>,
    <span class="dt">cost_drugs =</span> <span class="dv">0</span>,
    <span class="dt">cost_total =</span> <span class="kw"><a href="../reference/discount.html">discount</a></span>(cost_health +<span class="st"> </span>cost_drugs, .<span class="dv">06</span>),
    <span class="dt">life_year =</span> <span class="dv">0</span>
  )</code></pre></div>
<p>Strategies must be first defined and run as in a standard deterministic analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">strat_mono &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_strategy.html">define_strategy</a></span>(
  <span class="dt">transition =</span> mat_trans_mono,
  state_A,
  state_B,
  state_C,
  state_D
)</code></pre></div>
<pre><code>## No named state -&gt; generating names.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">strat_comb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_strategy.html">define_strategy</a></span>(
  <span class="dt">transition =</span> mat_trans_comb,
  state_A,
  state_B,
  state_C,
  state_D
)</code></pre></div>
<pre><code>## No named state -&gt; generating names.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res_mod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_model.html">run_model</a></span>(
  <span class="dt">mono =</span> strat_mono,
  <span class="dt">comb =</span> strat_comb,
  <span class="dt">parameters =</span> param,
  <span class="dt">cycles =</span> <span class="dv">50</span>,
  <span class="dt">cost =</span> cost_total,
  <span class="dt">effect =</span> life_year
)</code></pre></div>
</div>
<div id="resampling-distributions" class="section level2">
<h2 class="hasAnchor">
<a href="#resampling-distributions" class="anchor"></a>Resampling distributions</h2>
<p>Now we can define the resampling distributions. The following parameters will be resampled:</p>
<ul>
<li>Relative risk.</li>
<li>Costs (such that cost are always positive).</li>
<li>Transition probability from AIDS to death.</li>
<li>The transition probabilities from state A.</li>
</ul>
<p>Since the log of a relative risk follows a lognormal distribution, relative risk follows a lognormal distribution whose mean is <code>rr</code> and standard deviation on the log scale can be deduced from the relative risk confidence interval.</p>
<p><span class="math display">\[rr \sim lognormal(\mu = .509, \sigma = .173)\]</span></p>
<p>Programmed as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rr ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">lognormal</a></span>(<span class="dt">mean =</span> .<span class="dv">509</span>, <span class="dt">sdlog =</span> .<span class="dv">173</span>)</code></pre></div>
<p>Usually costs are resampled on a gamma distribution, which has the property of being always positive. Shape and scale parameters of the gamma distribution can be calculated from the mean and standard deviation desired in the distribution. Here we assume that <em>mean = variance</em>.</p>
<p><span class="math display">\[cost_A \sim \Gamma(\mu = 2756, \sigma = \sqrt{2756})\]</span></p>
<p>This can be programmed as:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cost_A ~<span class="st"> </span><span class="kw">make_gamma</span>(<span class="dt">mean =</span> <span class="dv">2756</span>, <span class="dt">sd =</span> <span class="kw">sqrt</span>(<span class="dv">2756</span>))</code></pre></div>
<p>Proportions follow a binomial distribution that can be estimated by giving the mean proportion and the size of the sample used to estimate that proportion with <code>p_CD ~ prop(prob = .25, size = 40)</code>.</p>
<p>Finally multinomial distributions are declared with the number of individuals in each group in the sample used to estimate the proportions. These proportions follow a Dirichlet distribution:</p>
<ul>
<li><code>p_AA + p_AB + p_AC + p_AD ~ multinomial(721, 202, 67, 10)</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rsp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_psa.html">define_psa</a></span>(
  rr ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">lognormal</a></span>(<span class="dt">mean =</span> .<span class="dv">509</span>, <span class="dt">sdlog =</span> .<span class="dv">173</span>),
  
  cost_A ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">gamma</a></span>(<span class="dt">mean =</span> <span class="dv">2756</span>, <span class="dt">sd =</span> <span class="kw">sqrt</span>(<span class="dv">2756</span>)),
  cost_B ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">gamma</a></span>(<span class="dt">mean =</span> <span class="dv">3052</span>, <span class="dt">sd =</span> <span class="kw">sqrt</span>(<span class="dv">3052</span>)),
  cost_C ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">gamma</a></span>(<span class="dt">mean =</span> <span class="dv">9007</span>, <span class="dt">sd =</span> <span class="kw">sqrt</span>(<span class="dv">9007</span>)),
  
  p_CD_mono ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">binomial</a></span>(<span class="dt">prob =</span> .<span class="dv">25</span>, <span class="dt">size =</span> <span class="dv">40</span>),
  
  p_AA_mono +<span class="st"> </span>p_AB_mono +<span class="st"> </span>p_AC_mono +<span class="st"> </span>p_AD_mono ~<span class="st"> </span><span class="kw"><a href="../reference/distributions.html">multinomial</a></span>(<span class="dv">721</span>, <span class="dv">202</span>, <span class="dv">67</span>, <span class="dv">10</span>)
)</code></pre></div>
</div>
<div id="run-probabilistic-model" class="section level2">
<h2 class="hasAnchor">
<a href="#run-probabilistic-model" class="anchor"></a>Run probabilistic model</h2>
<p>Now that the distributions of parameters are set we can simply run the probabilistic model as follow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_psa.html">run_psa</a></span>(
  <span class="dt">model =</span> res_mod,
  <span class="dt">psa =</span> rsp,
  <span class="dt">N =</span> <span class="dv">100</span>
)</code></pre></div>
<pre><code>## Resampling strategy 'mono'...</code></pre>
<pre><code>## Resampling strategy 'comb'...</code></pre>
<p>The average results are computed. In theory these values are more accurate than simple estimates because of non-linearities. An optional <code>threshold</code> can be passed to <code>summary()</code> to compute net monetary benefit.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(pm, 
        <span class="dt">threshold =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">5000</span>, <span class="dv">6000</span>, <span class="fl">1e4</span>))</code></pre></div>
<pre><code>## 2 strategies run for 50 cycles.
## 
## Initial state counts:
## 
## A = 1000L
## B = 0L
## C = 0L
## D = 0L
## 
## Counting method: 'life-table'.
## 
## Values:
## 
##      cost_health cost_drugs cost_total life_year
## comb   100457834   79138707   94397106 18134.443
## mono    50116918   20136936   49825813  8839.744
## 
## Net monetary benefit difference:
## 
##       1000     5000    6000   10000
## 1 35276.59    0.000     0.0     0.0
## 2     0.00 1902.202 11196.9 48375.7
## 
## Efficiency frontier:
## 
## mono -&gt; comb
## 
## Differences:
## 
##      Cost Diff. Effect Diff.     ICER Ref.
## comb   44571.29     9.294699 4795.345 mono</code></pre>
</div>
<div id="result-interpretation" class="section level2">
<h2 class="hasAnchor">
<a href="#result-interpretation" class="anchor"></a>Result interpretation</h2>
<p>The results of the analysis can be plotted on the cost-effectiveness plane. We can see there seem to be little uncertainty on the costs compared to the uncertainty on the effects, resulting in an uncertainty cloud that looks like a line.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"ce"</span>)</code></pre></div>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-9-1.png" width="576" style="display: block; margin: auto;"></p>
<p>And as cost-effectiveness acceptability curves or EVPI:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"ac"</span>, <span class="dt">max_wtp =</span> <span class="dv">10000</span>, <span class="dt">log_scale =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"evpi"</span>, <span class="dt">max_wtp =</span> <span class="dv">10000</span>, <span class="dt">log_scale =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-10-2.png" width="576" style="display: block; margin: auto;"></p>
<p>To compute EVPPI the results can also be exported with <code><a href="../reference/export_savi.html">export_savi()</a></code> in a format compatible with the <a href="http://savi.shef.ac.uk/SAVI/">SAVI</a> software (Sheffield Accelerated Value of Information).</p>
<p>A covariance analysis can be performed on strategy results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"cov"</span>)</code></pre></div>
<pre><code>## Loading required namespace: mgcv</code></pre>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Or on the difference between strategies:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"cov"</span>, <span class="dt">diff =</span> <span class="ot">TRUE</span>, <span class="dt">threshold =</span> <span class="dv">5000</span>)</code></pre></div>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-12-1.png" width="384" style="display: block; margin: auto;"></p>
<p>As usual plots can be modified with the standard <code>ggplot2</code> syntax.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="kw">plot</span>(pm, <span class="dt">type =</span> <span class="st">"ce"</span>) +
<span class="st">  </span><span class="kw">xlab</span>(<span class="st">"Life-years gained"</span>) +
<span class="st">  </span><span class="kw">ylab</span>(<span class="st">"Additional cost"</span>) +
<span class="st">  </span><span class="kw">scale_color_brewer</span>(
    <span class="dt">name =</span> <span class="st">"Strategy"</span>,
    <span class="dt">palette =</span> <span class="st">"Set1"</span>
  ) +
<span class="st">  </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="e-probabilistic_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="parallel-computing" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-computing" class="anchor"></a>Parallel computing</h2>
<p>Resampling can be significantly sped up by using parallel computing. This can be done in the following way:</p>
<ul>
<li>Define a cluster with the <code><a href="../reference/cluster.html">use_cluster()</a></code> functions (i.e. <code><a href="../reference/cluster.html">use_cluster(4)</a></code> to use 4 cores).</li>
<li>Run the analysis as usual.</li>
<li>To stop using parallel computing use the <code><a href="../reference/cluster.html">close_cluster()</a></code> function.</li>
</ul>
<p>Results may vary depending on the machine, but we found speed gains to be quite limited beyond 4 cores.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#model-definition">Model definition</a></li>
      <li><a href="#resampling-distributions">Resampling distributions</a></li>
      <li><a href="#run-probabilistic-model">Run probabilistic model</a></li>
      <li><a href="#result-interpretation">Result interpretation</a></li>
      <li><a href="#parallel-computing">Parallel computing</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Antoine Filipovic-Pierucci, Kevin Zarca.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
