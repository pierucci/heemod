<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibrating `heemod` models • heemod</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calibrating `heemod` models">
<meta property="og:description" content="heemod">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">heemod</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.14.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pierucci/heemod/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="k_calibration_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="k_calibration_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="k_calibration_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calibrating <code>heemod</code> models</h1>
            
            <h4 class="date">2020-12-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pierucci/heemod/blob/master/vignettes/k_calibration.Rmd"><code>vignettes/k_calibration.Rmd</code></a></small>
      <div class="hidden name"><code>k_calibration.Rmd</code></div>

    </div>

    
    
<p>The parameters for health economic models can be difficult to measure, either because they cannot be observed directly, or because appropriate data are not systematically gathered in the area of interest. When expected model results are know, <em>model calibration</em> is the search for the appropriate value of initially unknown parameters that allow to obtain these results.</p>
<p>For example the shape and scale parameters of a Weibull survival model can be unknown parameter values. But from the litterature we can know the expected probability of being alive at time <em>t</em>. If this probability is a result from the model, we can find the value of the shape and scale parameters that allow the model results to match, as closely as possible, the observed probability of being alive.</p>
<p>In order to perform calibration, the user must provide:</p>
<ol style="list-style-type: decimal">
<li>A heemod object from <code><a href="../reference/run_model.html">run_model()</a></code> of <code><a href="https://rdrr.io/r/stats/update.html">update()</a></code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</li>
<li>The names of the parameters of the model to calibrate (the parameters for which we seek appropriate values).</li>
<li>A function that when applied to the model returns the result we want to match with reference values.</li>
<li>The target values we would like the model results to match.</li>
</ol>
<p>For this example we will use the result from the assessment of a new total hip replacement previously described in <code>vignette("d-non-homogeneous", "heemod")</code>.</p>
<p>We will calibrate the parameters <code>gamma</code> (a Weibull survival parameter) and <code>rrNP1</code> (the relative risk associated with the new treatment), which originally have values of 1.45 and 0.26 respectively.</p>
<p>The original number of patients with a THR revision after 20 cycles are found in this way:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/get_counts.updated_model.html">get_counts</a></span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">markov_cycle</span> <span class="op">==</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">state_names</span> <span class="op">==</span> <span class="st">"RevisionTHR"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   .strategy_names markov_cycle state_names count
##   &lt;chr&gt;                  &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1 standard                  20 RevisionTHR 2.60 
## 2 np1                       20 RevisionTHR 0.690</code></pre>
<p>We want to calibrate <code>gamma</code> and <code>rrNP1</code> to obtain 3 patients for the <code>standard</code> strategy and 1 patient for the <code>np1</code> strategy at time 20. We need to define a function to extract the values we want to change from the model and return them as a numeric vector:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">extract_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/get_counts.updated_model.html">get_counts</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
    <span class="va">markov_cycle</span> <span class="op">==</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">state_names</span> <span class="op">==</span> <span class="st">"RevisionTHR"</span>
  <span class="op">)</span><span class="op">$</span><span class="va">count</span>
<span class="op">}</span>
<span class="fu">extract_values</span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2.5964891 0.6902178</code></pre>
<p>Any arbitrary function of any model output would work, as long as it returns numeric values.</p>
<p>A convenience function <code><a href="../reference/define_calibration_fn.html">define_calibration_fn()</a></code> exists to help easily define calibration functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">calib_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_calibration_fn.html">define_calibration_fn</a></span><span class="op">(</span>
  type <span class="op">=</span> <span class="st">"count"</span>,
  strategy_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"standard"</span>, <span class="st">"np1"</span><span class="op">)</span>,
  element_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RevisionTHR"</span>, <span class="st">"RevisionTHR"</span><span class="op">)</span>,
  cycles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu">calib_fn</span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2.5964891 0.6902178</code></pre>
<p>We can now call <code><a href="../reference/calibrate_model.html">calibrate_model()</a></code>, and give the values we want to reach as <code>target_values</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_model.html">calibrate_model</a></span><span class="op">(</span>
  <span class="va">res_mod</span>,
  parameter_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"rrNP1"</span><span class="op">)</span>,
  fn_values <span class="op">=</span> <span class="va">extract_values</span>,
  target_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">0.8</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Le chargement a nécessité le package : optimx</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res_cal</span></code></pre></div>
<pre><code>##      gamma     rrNP1        value convcode
## 1 1.442252 0.3144459 8.630486e-11        0</code></pre>
<p>The new parameter values are 1.44 for <code>gamma</code> and 0.31 for <code>rrNP1</code>. The <code>convcode</code> code at 0 indicates the calibration was successful.</p>
<p>It is possible to specify several possible starting values for the calibration procedure in order to explore the parameter space:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span><span class="op">)</span>,
  rrNP1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">res_cal_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_model.html">calibrate_model</a></span><span class="op">(</span>
  <span class="va">res_mod</span>,
  parameter_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"rrNP1"</span><span class="op">)</span>,
  fn_values <span class="op">=</span> <span class="va">extract_values</span>,
  target_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,
  initial_values <span class="op">=</span> <span class="va">start</span>,
  lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Additional options to control the optimization process can be passed to <code><a href="../reference/calibrate_model.html">calibrate_model()</a></code>. These options are parameters of the <a href="https://CRAN.R-project.org/package=optimx">optimx</a> function, such as <code>upper</code> and <code>lower</code> to specify upper and lower values, <code>method</code> to change the optimization method, etc.</p>
<p>Calibration uses optimization to minimize the sum of squared errors between calculated and desired values, and so is subject to all the many difficulties of optimization. Different optimization methods, for example Nelder-Mead (which does not require gradients) and BFGS or conjugate gradient methods, which do require gradients but can approximate them numerically, may work better for different problems. Some attempted optimizations may not converge.</p>
<p>It may be impossible to evaluate the function at badly-specified initial parameter values (for example, if a negative initial value is given for a parameter that must be positive); using box limits on some parameters may help with this.</p>
<p>Even if the calibration converges from different initial values, it may not converge to the same parameter values every time; in general, an underconstrained model can have different parameter sets that fit equally well. For these and other reasons, the user is advised to carefully check the results of calibrations.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Calibrating models from <code><a href="https://rdrr.io/r/stats/update.html">update()</a></code> is <em>extremely</em> time-consuming.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin Zarca, Antoine Filipovic-Pierucci.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
