---
title: "Using the survival analysis features of heemod"
author: "Matt Wiener"
date: "November 29, 2016"
output: 
     html_document:
          theme: spacelab
          toc: true
          
vignette: >
  %\VignetteIndexEntry{Survival analysis in heemod}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(knitr)
library(heemod)
library(readxl)
library(dplyr)
library(ggplot2)
library(readr)
library(printr)
library(flexsurv)
library(survival)

```

## Changes in the specification file for survival analysis
To tell `heemod` to use survival data in its analysis,
we must include some additional elements in the specification
file.    There are two ways to give the package
survival models:

* by passing in survival data and information on the model
    to be fit; or

* by specifying, in text, a survival distribution with parameters.

We will demonstrate each of these in turn.

```{r spec_file, echo = FALSE}
onc_file <- 
system.file("tabular/surv", "example_oncSpecs.csv", package = "heemod")
onc_spec <- read.csv(onc_file, header = TRUE)
print(onc_spec, rownames = FALSE)
```

The first new field is `survivalDataDirectory`, which, unsurprisingly, 
names a directory where survival data can be found.   The data is further
specified by sets of two or three additional fields.  In the example above,
which is based on oncology,
these are in rows 8 - 10 for *PFS*, or progression-free survival, and
rows 11 - 13 for *OS*, or overall survival.   Each set contains a name
for the fit, which can later be used to refer to the fit, for example, in
specifying parameters; the name of the file where survival is to be found, 
and the name of a file in which to store the fit for later use.  The fit name
is required, and at least one of the other two names must also be given.

The names for the three fields are `fit_name_<label>`,
`surv_data_file_<label>`, and `fit_file_<label>`, where
`<label>` identifies that the fields go together for a single fit.
In the example above, the labels used are `pfs` and `os`.  As
with other elements of the tabular input files, the field name goes in the
first, or `data` column, and the value goes in the second, `file`,
column.   

Here are the actions taken depending on which inputs are provided:


|  surv_data    | fit file | actions |
|:-------:|:---:|---|
|  Y        |  Y        |  survival models fit, and model saved     |
|  Y       |  N        |  survival models fit but not saved        |
|  N       |  Y        |  survival models read in from previous fit|
|  N       |  N        |  error                                   |

A survival fit will be saved twice - once as an R object, created
by `save` in a file with suffix `.RData`, 
and once in a text-based R dump file with suffix `.R`.  Fits are loaded
from the saved `.RData` file.

## Fitting survival models

The survival data must come in the format expected by the \code{survival}
and \code{flexsurv} packages.  In general, this means it will come in
a data frame with columns giving at least event time, censorship status (1 for
an event and 0 if a subject is lost to observation).  An additional column
can specify group membership for the subject of each event, for example
which treatment a subject in a clinical trial was receiving.   Survival
analysis in R generally supports left-censorship as well; `heemod` currently
does not.

When the program is provided with survival data to fit, it fits a model
for each group specified in the data file.  Six fits are obtained for each 
group, under (currently)
six different distributional assumptions:  exponential (`exp`),
Weibull (`weibull`), lognormal (`lnorm`), gamma (`gamma`),
Gompertz (`gompertz`), and generalized gamma (`gengamma`).
Additional distributions supported by the `flexsurv` package can
be added.

The best distribution for each group is selected based on the fit criterion
in the specification file.  The fit criterion can
also be specified in the `fit_metric` field, which can take
on the values `AIC`, `BIC`, or `m2LL`, which represent the
Akaike information criterion, the Bayes information criterion, and
minus twice the log likelihood, respectively.  The default is `AIC`.

Once survival models exist, they can be used to define parameters, as in 
the following rows:
```{r param_file, echo = FALSE}
param_file <- 
system.file("tabular/surv", "example_oncParams.csv", package = "heemod")
onc_param <- read.csv(param_file, header = TRUE)
print(onc_param[19:22, c("parameter", "value")], row.names = FALSE)
```

The parameters can, in turn, be used in the transition matrix, just as
in `heemod` models without the use of survival analysis.  The fact that
the relevant parameters are defined in terms of survival analysis makes
no difference.   Below we show part of a transition matrix.
```{r transition_file, echo = FALSE}
tm_file <- 
system.file("tabular/surv", "example_oncTransitionProbs.csv", package = "heemod")
onc_tm <- read.csv(tm_file, header = TRUE)
print(onc_tm[1:7, -1], row.names = FALSE)
```


## Supplying explicit probability distributions

Particularly in early modeling, we may not have data to hand.   It is
possible, and sometimes desirable, to simulate data and then have the 
program fit a model to the simulated data.
However, when desired, survival distributions can be specified
explicitly.   When this is done, the `surv_data_file` field holds,
instead of a file name, a list, as below in lines 8 and 11 (the lines have
been moved up compared to the previous specification file because we have
removed the line for the transition matrix file):
```{r spec_file_explicit_dists, echo = FALSE}
onc_file <- 
system.file("tabular/surv", "example_oncSpecs_explicit_dists.csv", 
            package = "heemod")
onc_spec_explicit_dist <- read.csv(onc_file, header = TRUE)
print(onc_spec_explicit_dist)
```
The code checks which situation it is in by checking whether the first
five characters of the value are "list(", which would be invalid as a file
name.   The list must have an element `dist_name`, which can be
any distribution name recognized by the `flexsurv` package.   Other
elements of the list must be arguments of the corresponding distribution, 
for example `rate` for the exponential distribution and `shape`
and `rate` for the gamma distribution in rows 8 and 11 above.  If
argument names don't match the arguments of the corresponding distribution,
the code will throw an error.

The `survivalDataDirectory` field must be supplied even when survival
distributions are specified explicitly as in this example.

## Partitioned survival models ##

As mentioned before, the specification file above does not have a line for
a transition matrix.   When no transition matrix is specified, 
`heemod` will use a partitioned survival model.  A partitioned
survival model determines the number of subjects dead at a given time
using the overall survival curve, and the number of progression-free
patients using the progression-free survival curve.  The number of
progression-free survivors is, by definition, always less than or equal to
the number of survivors.  The difference is the number of subjects with
progressive disease.

In `heemod`, the difference between using a Markov model and using
a partitioned survival model ends once the state counts at each time are
calculated.   Calculation of costs and utilities, and all output, are
identical.


### Kaplan-Meier curves and parametrically modeled survival values ###

When a survival model is fit, we have two possible estimates of survival
probabilities at any point.  On the one hand, we can use the
Kaplan-Meier estimate, that is, the portion of people actually surviving
in the measured data for a given trial.  This estimate is available only
until the end of the measured data.  On the other hand, we may prefer to
use the values predicted by a fitted survival model - and, if we want to
extrapolate beyond the time for which we have data, we have no
Kaplan-Meier available and must use predictions from a fitted model.  In
`heemod`, this is controlled by the `km_until` parameter, which, 
like other parameters, should be specified in the parameter file 
(for details, see the model specification and tabular input vignettes).

As the name suggests, the Kaplan-Meier curve will be used at all times
less than `km_until`, and predicted values will be used thereafter.
Setting `km_until = 0` will use only predicted values, while setting
`km_until = Inf` (or some number larger than the time under analysis)
will use only Kaplan-Meier estimates.  If a Kaplan-Meier estimate is
requested where none is available, an error will be thrown.

The plot below demonstrates the difference between the (black, jagged)
Kaplan-Meier estimate for the curve and the (red, smooth) predicted
survival probabilities. (Confidence intervals, which would be plotted by
default, have been suppressed for clarity.) 
The upper pair of curves shows overall survival, 
while the lower pair of curves shows progression-free survival.
In a case where no transition matrix is given, counts would
be read off this graph.  `km_until` determines where the counts would
switch over from the black Kaplan-Meier estimates to the red exponential
fits. 
```{r KM_vs_pred, echo = FALSE}
set.seed(100)
temp <- data.frame(time = round(c(rexp(50, rate = 1/25), 
                                rexp(50, rate = 1/75))),
                   group = rep(c("PFS", "OS"), each = 50),
                   status = rep(1, 100))

temp_fit <- flexsurvreg(Surv(time, status) ~ group, data = temp, dist = "exp")
plot(temp_fit, type = "survival", log = FALSE, ci = FALSE, conf.int = FALSE)

```

