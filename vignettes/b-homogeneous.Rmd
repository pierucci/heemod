---
title: "Simple Markov Models (Homogeneous)"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Simple Markov Models (Homogeneous)}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, echo=FALSE, include=FALSE}
library(heemod)
library(ggplot2)
```

The most simple Markov models in health economic evaluation are models were transition probabilities between states do not change with time. Those are called *homogeneous* or *time-homogeneous* Markov models.

If you are not familiar with `heemod`, first consult the introduction vignette `vignette("introduction", package = "heemod")`.

# Model description

In this example we will model the cost effectiveness of lamivudine/zidovudine combination therapy in HIV infection ([Chancellor, 1997](https://www.ncbi.nlm.nih.gov/pubmed/10169387)) further described in [Decision Modelling for Health Economic Evaluation](http://ukcatalogue.oup.com/product/9780198526629.do), page 32. For the sake of simplicity we will not reproduce exactly the analysis from the book. See vignette `vignette("reproduction", package = "heemod")` for an exact reproduction of the analysis.

This model aims to compare costs and utilities of two treatment strategies, *monotherapy* and *combined therapy*.

Four states are described, from best to worst healtwise:

  * __A__: CD4 cells > 200 and < 500 cells/mm3;
  * __B__: CD4 < 200 cells/mm3, non-AIDS;
  * __C__: AIDS;
  * __D__: Death.

# Transition probabilities

Transition probabilities for the monotherapy study group are rather simple to implement:

```{r}
mat_mono <-
  define_matrix(
    .721, .202, .067, .010,
    .000, .581, .407, .012,
    .000, .000, .750, .250,
    .000, .000, .000, 1.00
  )
mat_mono
```

The combined therapy group has its transition probabilities multiplied by `rr`, the relative risk of event for the population treated by combined therapy. Since $rr < 1$, the combined therapy group has less chance to transition to worst health states.

The probabilities to stay in the same state are equal to $1 - \sum p_{trans}$ where $p_{trans}$ are the probabilities to change to another state (because all transition probabilities from a given state must sum to 1).

We use the alias `C` as a convenient way to specify the probability complement, equal to `1 - sum(row probabilities)`

```{r}
rr <- .509

mat_comb <-
  define_matrix(
    C,    .202*rr, .067*rr, .010*rr,
    .000, C,       .407*rr, .012*rr,
    .000, .000,    C,       .250*rr,
    .000, .000,    .000,    1.00
  )
mat_comb
```

We can plot the transition matrix for the monotherapy group:

```{r, fig.width = 6, fig.height=6, fig.align='center'}
plot(mat_mono)
```

And the combined therapy group:

```{r, fig.width = 6, fig.height=6, fig.align='center'}
plot(mat_comb)
```

# State values

The costs of lamivudine and zidovudine are defined:

```{r}
cost_zido <- 2278
cost_lami <- 2086
```

In addition to drugs costs (called `cost_drugs` in the model), each state is associated to healthcare costs (called `cost_health`). Cost are discounted at a 6% rate with the `discount` function.

Efficacy in this study is measured in terms of life expectancy (called `life_year` in the model). Each state thus has a value of 1 life year per year, except death who has a value of 0. Life-years are not discounted in this example.

For example state A can be defined with `define_state`:

```{r}
A_mono <-
  define_state(
    cost_health = 2756,
    cost_drugs = cost_zido,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
A_mono
```

The other states for the monotherapy treatment group can be specified in the same way:

```{r}
B_mono <-
  define_state(
    cost_health = 3052,
    cost_drugs = cost_zido,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
C_mono <-
  define_state(
    cost_health = 9007,
    cost_drugs = cost_zido,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
D_mono <-
  define_state(
    cost_health = 0,
    cost_drugs = 0,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 0
  )
```

Similarly, for the the combined therapy treatment group, only `cost_drug` differs from the monotherapy treatment group:

```{r}
A_comb <-
  define_state(
    cost_health = 2756,
    cost_drugs = cost_zido + cost_lami,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
B_comb <-
  define_state(
    cost_health = 3052 + cost_lami,
    cost_drugs = cost_zido,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
C_comb <-
  define_state(
    cost_health = 9007 + cost_lami,
    cost_drugs = cost_zido,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 1
  )
D_comb <-
  define_state(
    cost_health = 0,
    cost_drugs = 0,
    cost_total = discount(cost_health + cost_drugs, .06),
    life_year = 0
  )
```

# Model definition

Models can now be defined by combining a transition matrix and a state list with `define_model`:

```{r}
mod_mono <- define_model(
  transition_matrix = mat_mono,
  A_mono,
  B_mono,
  C_mono,
  D_mono
)
mod_mono
```

For the combined therapy model:

```{r}
mod_comb <- define_model(
  transition_matrix = mat_comb,
  A_comb,
  B_comb,
  C_comb,
  D_comb
)
```

# Running models

Both models can then be run for 20 years with `run_model`. Models are given simple names (`mono` and `comb`) in order to facilitate result interpretation.

```{r}
res_mod <- run_models(
  mono = mod_mono,
  comb = mod_comb,
  cycles = 20,
  cost = cost_total,
  effect = life_year
)
```

By default models are run for one person starting in the first state (here state A).

Model values can then be compared with `summary`:

```{r}
summary(res_mod)
```

The incremental cost-effectiveness ratio of the combiend therapy strategy is thus Â£6335 per life-year gained.

The counts per state can be plotted for the monotherapy group:

```{r, fig.align='center', fig.width=6, message=FALSE}
plot(res_mod, model = "mono", type = "counts") +
  xlab("Time") +
  theme_minimal() +
  scale_color_brewer(
    name = "State",
    palette = "Set1"
  )
```

And the combined therapy group:

```{r, fig.align='center', fig.width=6, message=FALSE}
plot(res_mod, model = "comb", type = "counts") +
  xlab("Time") +
  theme_minimal() +
  scale_color_brewer(
    name = "State",
    palette = "Set1"
  )
```

Note that classic `ggplot2` syntax can be used to modifiy plot appearance.
