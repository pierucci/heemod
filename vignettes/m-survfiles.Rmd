---
title: "Running survival models from tabular data"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true 
vignette: >
  %\VignetteIndexEntry{Survival models}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}
library(heemod)
knitr::opts_chunk$set(echo = TRUE)
library(flexsurv)
```

Running an oncology cost/benefit model in heemod involves several steps:

* Fit available survival data under different distributional assumptions.

* Examine the survival fits and decide which ones are most appropriate to use in the economic model.

* Run the economic model in heemod with the chosen survival fits.

This document will demonstrate how to accomplish those steps in heemod,
using simulated data sets included with the package.

```{r fits}
base_dir <- system.file("tabular\\surv", package = "heemod")
spec_file <- "example_oncSpecs_nomatrix.csv"
```

Other vignettes cover more general information on the files needed to run heemod from [tabular input](h-tabular.html), and additional
information on [survival curve fitting](j-survival.html). 
Here we will deal only with those aspects specific to fitting survival curves
from data and using them to run economic models.

The source of the survival data, as well as the names and locations of the resulting fits, are specified in a file with the following rows:

name | meaning
-------------------------|------------------------------------------------------------------
survivalDataDirectory	   | the subdirectory in which survival data are kept
surv_data_file_suffix	   | the name of the file in survivalDataDirectory in which the survival data for either OS or PFS (depending on the suffix) will be found
fit_name_suffix	         | the name of the R object in which to save the fits
fit_file_suffix	         | the file in which to save the fits

In this case, suffix must contain either “pfs” or “os” (not case sensitive), and one set of each must be included. The suffixes determine which rows go together. Here’s an example of such a file, pointing to an example using randomly-generated data and two fake treatments, “A” and “B”:

```{r sim-data}
surv_inf_file_name <- "survival_info.csv"
full_path <- file.path(base_dir, surv_inf_file_name)
surv_info <- heemod:::read_file(full_path)
print(surv_info)
```

Here the fit names are not simply “OS.fit” and “PFS.fit”, but “OS2.fit” and “PFS2.fit”, a change that merely demonstrates that we can use different names if we choose.

The function `partitioned_survival_from_tabular` fits the survival models 
to data.
Here we use `save_fits = TRUE`; it is also possible to set `save_fits = FALSE`
to obtain the fits in R without saving them to a file. The specification file
will be used again to run the economic model, but to create the fits it need
only the `survivalInformation field`. If desired, the rest of the fields can be
added later.

The distributions currently used for survival fits are exponential, Weibull, lognormal, gamma, Gompertz, and generalized gamma. If fitting fails for some distribution, `heemod` will note the error and continue, so results will be available for the other distributional assumptions.

```{r make-fits}
temp1 <- survival_fits_from_tabular(base_dir, spec_file, 
                                    save_fits = TRUE)[[1]]
```

Fit quality can be examined using the negative log-likelihood, the Aikake
and Bayes information critera, and various kinds of graphs. 
(`sapply_matrix` returns a matrix of the results of `sapply` with the same
dimension and dimension names as the original matrix.)

```{r}
names(temp1)
```

```{r}
sapply_matrix(temp1$OS2.fit, "[[", "AIC")
```
`heemod` does not automatically choose a distribution to use in the survival model - the modeler must choose the most appropriate distribution for each set of survival data.

When a modeler has decided to run the economic analysis using a particular set of fits, the specification must be included in a file.  The name of the file goes in the
specification file, in a row with `data` element `use_fits`.

The file has three or four columns: \itemize{
\item{`.strategy`, corresponding to the strategies in the model;}
\item{`.type`, which for each row is either 'pfs' or 'os';}
\item{`dist`,  specifying the survival distribution to use;}
\item{`until` (optionally), specifying when the distribution ceases to apply.}
}
`until` needs to be specified only if there is more than one row with the same
`.strategy` and `.type`.  In that case, each distribution will pick up where
the previous one left off.   (The rows need not be presented in order, though
that is a good practice for readability; the code will sort distributions into
order by `until`.)   Here we don't require it.

If we define `use_fits` as
```{r define_fits}
use_fits_file <- file.path(base_dir, "use_fits_example0.csv")
use_fits <- heemod:::read_file(use_fits_file)
```

then the analysis will use an exponential survival model for overall survival for both strategies, but will use the gamma survival model for progression-free survival for A, and a lognormal survival model for progression-free survival for B.

The same specification file that was used for survival_fits_from_tabular can be used for run_model_tabular. run_model_tabular uses the information in the specification file to pick up the desired fits from those created earlier. No survival fitting happens when running  run_model_tabular, only selection.  The selection is governed by the `use_fits` element of the reference file.

In this example, we’ve used a different choice. Here is the use_fits element of this file:
```{r}
ref <- heemod:::read_file(file.path(base_dir, spec_file))
use_fits_file <- file.path(base_dir, ref[ref$data == "use_fits", "file"])
use_fits <- heemod:::read_file(use_fits_file)
use_fits
```

```{r}
surv_example <- run_model_tabular(base_dir, spec_file,
                                  run_psa = FALSE, run_demo = FALSE,
                                  save = FALSE, overwrite= FALSE)
```
Note that we got a warning here because partitioned survival models do not use the “method” element.
But the model has run as requested:
```{r fig.width=8, fig.height=5}
plot(surv_example$model_runs)
```

We can also mix explicit survival distribution definitions with fits,
as shown below.
```{r}
spec_file <- "example_oncSpecs_nomatrix_mixed.csv"
ref <- heemod:::read_file(file.path(base_dir, spec_file))
mixed_use_fits_file <- file.path(base_dir, ref[ref$data == "use_fits", "file"])
mixed_use_fits <- heemod:::read_file(mixed_use_fits_file)
mixed_use_fits
```

```{r fig.width = 8, fig.height = 5, run_mixed_dist}
surv_example_mixed <- run_model_tabular(base_dir, spec_file,
                                  run_psa = FALSE, run_demo = FALSE,
                                  save = FALSE, overwrite= FALSE)
plot(surv_example_mixed$model_runs)
```
